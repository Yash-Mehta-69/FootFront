{% extends 'vendor_base.html' %}

{% block title %}Edit Product | Vendor Panel{% endblock %}

{% block header_title %}Edit Product{% endblock %}
{% block breadcrumb %}Products / Edit{% endblock %}

{% block vendor_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="custom-card">
            <div class="card-header-custom">
                <h5 class="card-title-custom">Product Information</h5>
            </div>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row g-3">
                    <!-- Basic Info -->
                    <div class="col-md-6">
                        <label class="form-label">Product Name</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="text-danger small">{{ form.name.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <div class="d-flex justify-content-between">
                            <label class="form-label">Category</label>
                            <a href="#" class="small text-decoration-none" onclick="openRequestModal('Category'); return false;">Request New?</a>
                        </div>
                        {{ form.category }}
                         {% if form.category.errors %}
                        <div class="text-danger small">{{ form.category.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Gender</label>
                        {{ form.gender }}
                         {% if form.gender.errors %}
                        <div class="text-danger small">{{ form.gender.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 d-flex align-items-center mt-4 pt-2">
                        <div class="form-check form-switch">
                            {{ form.is_trending }}
                            <label class="form-check-label ms-2" for="isTrending">Is Trending?</label>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        {{ form.description }}
                         {% if form.description.errors %}
                        <div class="text-danger small">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-12">
                         <label class="form-label">Main Image</label>
                         {% if product.product_image %}
                             <div class="d-flex align-items-center mb-2">
                                 <img src="{{ product.product_image.url }}" alt="Product Image" class="img-thumbnail me-3" style="width: 100px; height: 100px; object-fit: cover;">
                             </div>
                         {% endif %}
                         <input type="file" name="product_image" class="form-control-custom">
                         {% if form.product_image.errors %}
                            <div class="text-danger small">{{ form.product_image.errors.0 }}</div>
                         {% endif %}
                    </div>

                    <!-- Variants Section -->
                    <div class="col-12 mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">Product Variants (Size & Color)</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVariantRow()">
                                <i class="fas fa-plus me-1"></i> Add Variant
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table-custom" id="variantTable">
                                <thead class="bg-light-custom">
                                    <tr>
                                        <th style="min-width: 100px;">
                                            Size <a href="#" onclick="openRequestModal('Size'); return false;"><i class="fas fa-plus-circle fa-xs"></i></a>
                                        </th>
                                        <th style="min-width: 100px;">
                                            Color <a href="#" onclick="openRequestModal('Color'); return false;"><i class="fas fa-plus-circle fa-xs"></i></a>
                                        </th>
                                        <th style="min-width: 100px;">Price</th>
                                        <th style="min-width: 80px;">Stock</th>
                                        <th style="min-width: 150px;">Image</th>
                                        <th style="width: 50px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for v in variants %}
                                    <tr>
                                        <input type="hidden" name="variant_id[]" value="{{ v.pk }}">
                                        <td>
                                            <select class="form-select-custom form-select-sm" name="variant_size[]">
                                                {% for s in sizes %}
                                                <option value="{{ s.pk }}" {% if v.size.pk == s.pk %}selected{% endif %}>{{ s.size_label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-select-custom form-select-sm" name="variant_color[]">
                                                {% for c in colors %}
                                                <option value="{{ c.pk }}" {% if v.color.pk == c.pk %}selected{% endif %}>{{ c.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td><input type="number" class="form-control-custom form-control-sm" name="variant_price[]" value="{{ v.price }}" step="0.01"></td>
                                        <td><input type="number" class="form-control-custom form-control-sm" name="variant_stock[]" value="{{ v.stock }}"></td>
                                        <td>
                                            <input type="file" class="form-control-custom form-control-sm mb-1" name="variant_image_{{ forloop.counter0 }}">
                                            {% if v.image %}
                                                <div class="mt-1">
                                                    <img src="{{ v.image.url }}" alt="Variant Image" class="rounded border" style="width: 40px; height: 40px; object-fit: cover;">
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="text-center"><button type="button" class="btn btn-sm text-danger" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                    {% empty %}
                                    <tr id="emptyRow">
                                        <td>
                                            <select class="form-select-custom form-select-sm" name="variant_size[]">
                                                 <option value="">Select</option>
                                                {% for s in sizes %}
                                                <option value="{{ s.pk }}">{{ s.size_label }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-select-custom form-select-sm" name="variant_color[]">
                                                <option value="">Select</option>
                                                {% for c in colors %}
                                                <option value="{{ c.pk }}">{{ c.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td><input type="number" class="form-control-custom form-control-sm" name="variant_price[]" placeholder="0.00" step="0.01"></td>
                                        <td><input type="number" class="form-control-custom form-control-sm" name="variant_stock[]" placeholder="0"></td>
                                        <td><input type="file" class="form-control-custom form-control-sm" name="variant_image_0"></td>
                                        <td class="text-center"><button type="button" class="btn btn-sm text-danger" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="col-12 mt-4 text-end">
                        <a href="{% url 'vendor_products' %}" class="btn btn-light-custom me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary-custom px-4">Update Product</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function addVariantRow() {
    let table = document.getElementById("variantTable").getElementsByTagName('tbody')[0];
    let rows = table.rows;
    let lastRow = rows[rows.length - 1];
    let newRow = lastRow.cloneNode(true);
    let rowCount = rows.length;
    
    // Clear inputs and update names in the new row
    let inputs = newRow.getElementsByTagName('input');
    for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].type !== 'hidden') {
            inputs[i].value = '';
        } else {
            // Remove hidden ID for new rows
            inputs[i].remove();
            i--; // Adjust index after removal
            continue;
        }
        
        if (inputs[i].type === 'file') {
            inputs[i].name = 'variant_image_' + rowCount;
            // Remove existing image preview if any
            let imgDiv = inputs[i].parentNode.querySelector('div.mt-1');
            if (imgDiv) imgDiv.remove();
        }
    }
    let selects = newRow.getElementsByTagName('select');
    for(let i=0; i<selects.length; i++){
        selects[i].selectedIndex = 0;
    }

    table.appendChild(newRow);
}

function removeRow(btn) {
    let row = btn.parentNode.parentNode;
    let table = row.parentNode;
    if(table.rows.length > 1){
        table.removeChild(row);
    } else {
        // Just clear the last remaining row
        let inputs = row.getElementsByTagName('input');
        for (let i = 0; i < inputs.length; i++) inputs[i].value = '';
        let selects = row.getElementsByTagName('select');
        for (let i = 0; i < selects.length; i++) selects[i].selectedIndex = 0;
    }
}
</script>
{% endblock %}