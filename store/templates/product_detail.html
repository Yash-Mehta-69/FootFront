{% extends 'base.html' %}
{% load static %}


{% block extra_css %}
<!-- Specific styles for Product Detail that extend global styles -->
<style>
    /* --- Layout & Tech Background --- */
    /* Increased padding to prevent navbar overlap */
    /* .pd-page-wrapper {
        padding-top: 120px; Increased to 220px for clear visibility
    } */

    /* --- Layout & Tech Background --- */
    .pd-media-container {
        position: relative;
        display: flex;
        flex-direction: column-reverse; /* Thumbs below image */
        gap: 20px;
        align-items: center;
        height: auto;
        margin-bottom: 2rem;
    }

    /* Main Image Wrapper */
    .pd-main-image-wrapper {
        position: relative;
        width: 100%;
        height: 550px; /* Consistent height viewport */
        background: radial-gradient(circle at center, rgba(255,255,255,0.03) 0%, transparent 70%);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2;
    }
    
    .pd-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s;
        filter: drop-shadow(0 20px 40px rgba(0,0,0,0.4));
    }
    .pd-image.changing {
        opacity: 0;
        transform: scale(0.9);
    }
    
    /* Hover Zoom */
    .pd-main-image-wrapper:hover .pd-image {
        transform: scale(1.1);
        cursor: crosshair;
    }

    /* Thumbnails - Horizontal Style */
    .pd-thumbnails {
        display: flex;
        flex-direction: row; /* Horizontal */
        gap: 15px;
        width: 100%;
        overflow-x: auto; /* Scroll horizontally */
        padding-bottom: 10px; 
        z-index: 3;
        justify-content: center; /* Center thumbs */
    }
    
    .pd-thumbnails::-webkit-scrollbar { height: 4px; }
    .pd-thumbnails::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 2px; }
    .pd-thumbnails::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }

    .pd-thumb {
        width: 80px;
        height: 80px;
        flex-shrink: 0; /* Don't squash */
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        object-fit: contain;
        opacity: 0.6;
    }
    .pd-thumb:hover {
        opacity: 1;
        border-color: var(--color-accent);
        transform: translateY(-2px);
    }
    .pd-thumb.active {
        opacity: 1;
        border-color: var(--color-accent);
        box-shadow: 0 0 15px rgba(204, 255, 0, 0.2);
        background: rgba(255,255,255,0.05);
        transform: scale(1.05);
    }

    /* Tech Frame - Background Accent */
    .pd-tech-frame {
        position: absolute;
        top: -10px; left: -10px; right: -10px; bottom: -10px;
        border: 1px solid var(--glass-border);
        z-index: 0;
        pointer-events: none;
        opacity: 0.2;
        border-radius: 24px;
    }


    /* --- Info Section --- */
    .pd-info {
        padding: 2.5rem;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius-card, 16px);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }
    /* Decorator Line */
    .pd-info::before {
        content: '';
        position: absolute;
        top: 0; left: 0; width: 4px; height: 100%;
        background: linear-gradient(to bottom, var(--color-accent), transparent);
    }

    .pd-category-link {
        color: var(--color-text-muted);
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 2px;
        text-decoration: none;
        transition: color 0.3s;
    }
    .pd-category-link:hover { color: var(--color-accent); }

    .pd-title {
        font-family: var(--font-heading);
        font-size: clamp(2rem, 4vw, 3.5rem);
        line-height: 1.1;
        margin: 0.5rem 0 1rem;
        color: var(--color-text);
        text-transform: uppercase;
    }

    .pd-price-box {
        display: flex;
        align-items: baseline;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .pd-price {
        font-family: var(--font-heading);
        font-size: 2.5rem;
        color: var(--color-accent);
        font-weight: 700;
    }

    /* --- Controls --- */
    .control-label {
        color: var(--color-text);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        margin-bottom: 0.8rem;
        display: flex;
        justify-content: space-between;
    }
    .control-value { color: var(--color-accent); margin-left: auto;}

    /* Color Swatches */
    .pd-colors {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 1.5rem;
    }
    .color-swatch {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--glass-border);
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.active { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.5); border-color: var(--color-accent); }
    .color-swatch.disabled { opacity: 0.1; pointer-events: none; filter: grayscale(1); }

    /* Tech Sizes */
    .pd-sizes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 10px;
        margin-bottom: 1.5rem;
    }
    .size-btn {
        height: 45px;
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--glass-border);
        color: var(--color-text);
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: var(--font-heading);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        /* Tech corner cut */
        clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .size-btn:hover:not(.disabled) {
        border-color: var(--color-accent);
        background: rgba(204, 255, 0, 0.05);
        color: var(--color-accent);
    }
    .size-btn.active {
        background: var(--color-accent);
        color: #000;
        border-color: var(--color-accent);
        box-shadow: 0 0 15px rgba(204, 255, 0, 0.3);
    }
    .size-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background: rgba(0,0,0,0.2);
        border-style: dashed;
    }

    /* Quantity & Actions */
    .action-row {
        display: grid;
        grid-template-columns: 120px 1fr auto;
        gap: 15px;
        margin-top: 2rem;
    }
    
    .qty-selector {
        display: flex;
        height: 55px;
        border: 1px solid var(--glass-border);
        border-radius: 8px; /* Fallback */
        overflow: hidden;
    }
    .qty-btn {
        width: 35px;
        background: rgba(255,255,255,0.05);
        border: none;
        color: var(--color-text);
        font-size: 1.2rem;
        cursor: pointer;
        transition: background 0.2s;
    }
    .qty-btn:hover { background: rgba(255,255,255,0.1); }
    .qty-input {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--color-text);
        text-align: center;
        font-weight: 600;
        width: 100%;
    }
    .qty-input:focus { outline: none; }

    .btn-add-cart {
        height: 55px;
        background: var(--color-bg);
        color: var(--color-accent);
        border: 1px solid var(--color-accent);
        font-family: var(--font-heading);
        text-transform: uppercase;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s;
        /* Dynamic clip path */
        clip-path: polygon(15px 0, 100% 0, 100% 100%, 0 100%, 0 15px);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    .btn-add-cart:hover:not(:disabled) {
        background: var(--color-accent);
        color: #000;
        box-shadow: 0 0 20px rgba(204, 255, 0, 0.4);
    }
    .btn-add-cart:disabled {
        border-color: var(--glass-border);
        color: var(--color-text-muted);
        cursor: not-allowed;
        background: rgba(255,255,255,0.02);
    }

    .btn-wishlist {
        height: 55px;
        width: 55px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--glass-border);
        background: transparent;
        color: var(--color-text);
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-wishlist:hover {
        border-color: #ff4757;
        color: #ff4757;
    }

    /* Vendor Card */
    .vendor-card {
        margin-top: 2rem;
        padding: 1.2rem;
        border-top: 1px dashed var(--glass-border);
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .vendor-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid var(--color-accent);
        object-fit: cover;
    }
    .vendor-info h6 {
        margin: 0;
        color: var(--color-text);
        font-family: var(--font-heading);
        font-size: 1.1rem;
    }
    .vendor-info p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--color-text-muted);
    }
    .btn-visit-shop {
        margin-left: auto;
        padding: 6px 16px;
        font-size: 0.8rem;
        border: 1px solid var(--glass-border);
        background: transparent;
        color: var(--color-text);
        border-radius: 20px;
        transition: all 0.3s;
    }
    .btn-visit-shop:hover {
        border-color: var(--color-accent);
        color: var(--color-accent);
    }

    /* --- Details Cards Section --- */
    .details-cards-section {
        margin-top: 4rem;
    }
    /* Updated for separate Light Theme Background */
    .details-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        padding: 2rem;
        height: 100%;
        border-radius: 12px;
        transition: transform 0.3s;
    }
    
    /* Specific styling for Light Theme Cards */
    [data-theme="light"] .details-card {
        background: #f1f2f6; /* Distinct Greyish BG for Light Mode */
        border: 1px solid #dcdde1;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    /* Fallback if data-theme isn't used */
    body.light-theme .details-card {
        background: #f1f2f6;
        border: 1px solid #dcdde1;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .details-card:hover {
        transform: translateY(-5px);
        border-color: var(--color-accent);
    }
    .details-card h4 {
        font-family: var(--font-heading);
        color: var(--color-accent);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* --- Reviews Section --- */
    .reviews-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 1px solid var(--glass-border);
    }
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .review-stats {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .big-rating {
        font-size: 3rem;
        font-weight: 700;
        color: var(--color-accent);
        line-height: 1;
    }
    
    .review-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    /* Review Card Styling with Theme awareness */
    .review-card {
        background: rgba(255,255,255,0.03); 
        border: 1px solid var(--glass-border);
        padding: 1.5rem;
        transition: transform 0.3s;
        border-radius: 12px;
    }
    
    /* Light Theme Review Card - Distinct BG */
    [data-theme="light"] .review-card {
        background: #ffffff !important; /* solid white */
        border: 1px solid #e2e2e2 !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.06) !important;
        backdrop-filter: none !important;
    }
    body.light-theme .review-card {
        background: #ffffff !important; 
        border: 1px solid #e2e2e2 !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.06) !important;
    }
    
    .review-card:hover { 
        transform: translateY(-8px); 
        background: rgba(255,255,255,0.05);
    }
    [data-theme="light"] .review-card:hover {
         background: #ffffff !important;
         border-color: var(--color-accent) !important;
         box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
    }
    
    /* Ensure text colors in review card match light mode */
    [data-theme="light"] .review-card h6 { color: #000 !important; }
    [data-theme="light"] .review-card .text-muted { color: #6c757d !important; opacity: 1 !important; }
    [data-theme="light"] .review-card .text-light-emphasis { color: #333 !important; opacity: 1 !important; }

    /* Text Colors in Review Card */
    .review-card h6 { color: #fff; }
    .review-card small { color: #aaa; }
    .review-card p { color: #eee; }

    /* Light Theme Text Overrides */
    [data-theme="light"] .review-card h6,
    body.light-theme .review-card h6 {
        color: #000000 !important;
    }
    [data-theme="light"] .review-card small,
    body.light-theme .review-card small {
        color: #6c757d !important;
    }
    [data-theme="light"] .review-card p,
    body.light-theme .review-card p {
        color: #333333 !important;
    }
    
    /* Animations */
    @keyframes spin-slow { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

    /* Modal Styles */
    .tech-modal {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        color: var(--color-text);
    }
    
    [data-theme="light"] .tech-modal {
        background: #ffffff;
        color: #000000;
        border: 1px solid #e0e0e0;
    }
    body.light-theme .tech-modal {
        background: #ffffff;
        color: #000000;
        border: 1px solid #e0e0e0;
    }
    
    /* Input Styles in Modal */
    .tech-modal .form-control {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: var(--color-text);
    }
    [data-theme="light"] .tech-modal .form-control,
    body.light-theme .tech-modal .form-control {
        background: #f8f9fa;
        border: 1px solid #ced4da;
        color: #000000;
    }
    
    /* Form Label Colors */
    .tech-modal .form-label { color: var(--color-text); }

    
    @media (max-width: 991px) {
        .pd-page-wrapper { padding-top: 100px; }
        .pd-media-container { 
            margin-bottom: 2rem; 
        }
        .pd-main-image-wrapper { 
            height: 400px; 
        }
        .pd-image { max-height: 90%; max-width: 90%; }
        
        .pd-thumb {
            min-width: 70px;
            width: 70px;
            height: 70px;
        }

        .action-row { grid-template-columns: 1fr 1fr; }
        .btn-wishlist { grid-column: 2; width: 100%; }
        .qty-selector { grid-column: 1; }
        .btn-add-cart { grid-column: 1 / -1; order: 3; }
    }
    /* --- Review Card Enhancements --- */
    .review-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        border-color: var(--color-accent) !important;
    }
    
    .media-thumb:hover {
        transform: scale(1.05);
        border-color: var(--color-accent) !important;
    }
    
    .media-thumb:hover .hover-overlay {
        opacity: 1 !important;
    }

    .custom-scrollbar::-webkit-scrollbar {
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: var(--color-accent);
        border-radius: 10px;
        opacity: 0.5;
    }
    
    #mediaContainer img, #mediaContainer video {
        animation: zoomIn 0.3s ease-out;
    }
    
    @keyframes zoomIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="pd-page-wrapper section-padding">
    <div class="container">
        
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4" style="margin-top: 1.5rem; position: relative; z-index: 10;">
            <ol class="breadcrumb bg-transparent p-0 m-0">
                <li class="breadcrumb-item"><a href="{% url 'shop' %}" class="pd-category-link">Shop</a></li>
                {% if product.category %}
                <li class="breadcrumb-item"><a href="{% url 'shop' %}?category={{ product.category.slug }}" class="pd-category-link">{{ product.category.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active text-muted" aria-current="page">{{ product.name }}</li>
            </ol>
        </nav>

        <div class="row g-5">
            <!-- LEFT: Media Gallery -->
            <div class="col-lg-7">
                <div class="pd-media-container">
                    <div class="pd-tech-frame"></div>
                    
                    <!-- Thumbnails (Left Side) -->
                    <div class="pd-thumbnails" id="thumbnail-container">
                         <!-- Main Image Thumb -->
                         {% if product.product_image %}
                         <img src="{{ product.product_image.url }}" class="pd-thumb active" onclick="switchImage(this.src)">
                         {% endif %}
                         
                         <!-- Variant Images (Unique Only) -->
                         {% for variant in variants %}
                            {% if variant.image and variant.image.url != product.product_image.url %}
                             <img src="{{ variant.image.url }}" class="pd-thumb" onclick="switchImage(this.src, '{{ variant.id }}')" data-variant-id="{{ variant.id }}">
                            {% endif %}
                         {% endfor %}
                    </div>

                    <!-- Main Image Area -->
                    <div class="pd-main-image-wrapper">
                        {% if product.product_image %}
                            <img id="main-image" src="{{ product.product_image.url }}" class="pd-image" alt="{{ product.name }}">
                        {% else %}
                            <div class="text-muted text-center">
                                <i class="fas fa-image fa-4x mb-3"></i><br>No Image Available
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- RIGHT: Product Info -->
            <div class="col-lg-5">
                <div class="pd-info">
                    <span class="pd-category">
                        {% if product.is_trending %}<span class="badge bg-danger me-2">TRENDING</span>{% endif %}
                        {{ product.get_gender_display }}
                    </span>
                    
                    <h1 class="pd-title">{{ product.name }}</h1>

                    <div class="pd-price-box">
                        <span class="pd-price" id="display-price">â‚¹{{ product.price }}</span>
                    </div>

                    <!-- Short Description (Snippet) -->
                    <p class="text-muted-theme mb-4 description-text">
                        {{ product.description|truncatewords:20 }}
                    </p>

                    <!-- Add to Cart Form -->
                    <form method="POST" action="{% url 'add_to_cart' product.id %}" id="add-to-cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="selected-variant-id" id="selected-variant-input">
                        
                        <!-- Color Section -->
                        {% if available_colors %}
                        <div class="mb-4">
                            <div class="control-label">
                                Color <span class="control-value" id="color-label">Select Color</span>
                            </div>
                            <div class="pd-colors">
                                {% for color in available_colors %}
                                <div class="color-swatch" 
                                     data-color="{{ color.name }}" 
                                     style="background-color: {{ color.hex_code }};"
                                     title="{{ color.name }}"
                                     onclick="selectColor('{{ color.name }}')">
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Size Section -->
                        {% if available_sizes %}
                        <div class="mb-4">
                            <div class="control-label">
                                Size <span class="control-value" id="size-label">Select Size</span>
                            </div>
                            <div class="pd-sizes">
                                {% for size in available_sizes %}
                                <div class="size-btn" 
                                     data-size="{{ size.size_label }}"
                                     onclick="selectSize('{{ size.size_label }}')">
                                    {{ size.size_label }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div id="stock-feedback" class="mb-3" style="min-height: 24px;"></div>

                        <!-- Actions -->
                        <div class="action-row">
                            <!-- Quantity -->
                            <div class="qty-selector">
                                <button type="button" class="qty-btn" onclick="updateQty(-1)">-</button>
                                <input type="number" name="quantity" id="qty-input" class="qty-input" value="1" min="1" max="5">
                                <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
                            </div>

                            <!-- Cart Button -->
                            <!-- Cart Button -->
                            <button type="button" id="add-btn" class="btn-add-cart" onclick="addToCart()" disabled>
                                <span>SELECT OPTIONS</span> <i class="fas fa-shopping-bag"></i>
                            </button>

                            <!-- Wishlist -->
                            <button type="button" class="btn-wishlist" title="Add to Wishlist" onclick="toggleWishlist(this)">
                                <i class="far fa-heart fa-lg"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Vendor Card -->
                    <div class="vendor-card">
                        {% if product.vendor.profile_picture %}
                            <img src="{{ product.vendor.profile_picture.url }}" class="vendor-avatar" alt="Vendor">
                        {% else %}
                            <div class="vendor-avatar d-flex align-items-center justify-content-center bg-dark text-accent">
                                <i class="fas fa-store"></i>
                            </div>
                        {% endif %}
                        <div class="vendor-info">
                            <p>Sold By Official Vendor</p>
                            <h6>{{ product.vendor.shopName }}</h6>
                        </div>
                        <a href="{% url 'vendor_shop' %}?id={{ product.vendor.id }}" class="btn-visit-shop">Visit Shop</a> 
                        <!-- Note: Adjust view_shop URL arg as needed, usually vendor slug or user id -->
                    </div>

                </div>
            </div>
        </div>

        <!-- NEW: Product Details Cards (Between Info and Reviews) -->
        <div class="details-cards-section">
            <h3 class="section-title mb-4" style="font-family: var(--font-heading); text-transform:uppercase;">Product Details</h3>
            <div class="row g-4">
                <!-- Card 1: Description -->
                <div class="col-md-4">
                    <div class="details-card">
                        <h4><i class="fas fa-info-circle"></i> Description</h4>
                        <p class="text-muted-theme">
                            {{ product.description }}
                            <br><br>
                            This {{ product.get_gender_display }}'s product is designed for ultimate comfort and style. Perfect for daily wear or specific athletic activities.
                        </p>
                    </div>
                </div>
                
                <!-- Card 2: Material & Specification (Static/Dummy if model missing) -->
                <div class="col-md-4">
                    <div class="details-card">
                        <h4><i class="fas fa-layer-group"></i> Specifications</h4>
                        <ul class="list-unstyled text-muted-theme">
                            <li class="mb-2"><strong>Category:</strong> {{ product.category.name }}</li>
                            <li class="mb-2"><strong>Gender:</strong> {{ product.get_gender_display }}</li>
                            <li class="mb-2"><strong>Vendor:</strong> {{ product.vendor.shopName }}</li>
                            <!-- Placeholder for Material -->
                            <li class="mb-2"><strong>Material:</strong> Premium Synthetic/Mesh</li> 
                        </ul>
                    </div>
                </div>

                <!-- Card 3: Shipping & Warranty -->
                <div class="col-md-4">
                    <div class="details-card">
                        <h4><i class="fas fa-truck"></i> Delivery & Care</h4>
                        <ul class="list-unstyled text-muted-theme">
                            <li class="mb-3"><i class="fas fa-shipping-fast text-success me-2"></i> <strong>Delivery:</strong> Shipments are managed directly by verified vendors.</li>
                            <li class="mb-3"><i class="fas fa-ban text-danger me-2"></i> <strong>No Returns:</strong> All sales are final. Please check sizing carefully.</li>
                            <li class="mb-3"><i class="fas fa-shield-alt text-warning me-2"></i> <strong>Authenticity:</strong> 100% Verified Authentic. Every pair is inspected by verfied vendors.</li>
                            <li class="mb-3"><i class="fas fa-hands-wash text-primary me-2"></i> <strong>Care:</strong> Wipe clean with a damp cloth. Do not machine wash.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- REVIEWS SECTION -->
        <div class="reviews-section" style="position: relative; z-index: 5;">
            <div class="row mb-5 align-items-center">
                <div class="col-md-4 text-center text-md-start mb-4 mb-md-0">
                    <h2 class="section-title text-uppercase mb-0">Customer Reviews</h2>
                    <div class="d-flex align-items-baseline gap-3 mt-2">
                        <span class="display-3 fw-bold text-accent">{{ avg_rating }}</span>
                        <div class="d-flex flex-column">
                            <div class="text-warning small mb-1">
                                {% with ''|center:5 as range %}
                                {% for _ in range %}
                                    <i class="{% if forloop.counter <= avg_rating %}fas{% elif forloop.counter|add:"-0.5" <= avg_rating %}fas fa-star-half-alt{% else %}far{% endif %} fa-star"></i>
                                {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="text-muted-theme small">{{ review_count }} Verified Reviews</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4 mb-4 mb-md-0">
                   <!-- Rating Bars (Dynamic) -->
                   <div class="d-flex align-items-center gap-2 mb-1">
                       <span class="small text-muted" style="width: 30px;">5 <i class="fas fa-star text-xs"></i></span>
                       <div class="progress flex-grow-1" style="height: 6px; background: rgba(255,255,255,0.1);">
                           <div class="progress-bar bg-accent" role="progressbar" style="width: {{ rating_percentages.5 }}%"></div>
                       </div>
                   </div>
                   <div class="d-flex align-items-center gap-2 mb-1">
                       <span class="small text-muted" style="width: 30px;">4 <i class="fas fa-star text-xs"></i></span>
                       <div class="progress flex-grow-1" style="height: 6px; background: rgba(255,255,255,0.1);">
                           <div class="progress-bar bg-accent" role="progressbar" style="width: {{ rating_percentages.4 }}%"></div>
                       </div>
                   </div>
                   <div class="d-flex align-items-center gap-2 mb-1">
                       <span class="small text-muted" style="width: 30px;">3 <i class="fas fa-star text-xs"></i></span>
                       <div class="progress flex-grow-1" style="height: 6px; background: rgba(255,255,255,0.1);">
                           <div class="progress-bar bg-accent" role="progressbar" style="width: {{ rating_percentages.3 }}%"></div>
                       </div>
                   </div>
                   <div class="d-flex align-items-center gap-2 mb-1">
                       <span class="small text-muted" style="width: 30px;">2 <i class="fas fa-star text-xs"></i></span>
                       <div class="progress flex-grow-1" style="height: 6px; background: rgba(255,255,255,0.1);">
                           <div class="progress-bar bg-accent" role="progressbar" style="width: {{ rating_percentages.2 }}%"></div>
                       </div>
                   </div>
                   <div class="d-flex align-items-center gap-2">
                       <span class="small text-muted" style="width: 30px;">1 <i class="fas fa-star text-xs"></i></span>
                       <div class="progress flex-grow-1" style="height: 6px; background: rgba(255,255,255,0.1);">
                           <div class="progress-bar bg-accent" role="progressbar" style="width: {{ rating_percentages.1 }}%"></div>
                       </div>
                   </div>
                </div>

                <div class="col-md-4 text-center text-md-end">
                    {% if user.is_authenticated %}
                    <button id="btnWriteReview" class="btn btn-primary px-4 py-3 fw-bold" style="pointer-events: auto;">
                        <i class="fas fa-pen-nib me-2"></i> WRITE A REVIEW
                    </button>
                    {% else %}
                    <a href="{% url 'login' %}" class="btn btn-outline-light px-4 py-3">
                        <i class="fas fa-sign-in-alt me-2"></i> Login to Review
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="review-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px;">
                {% if reviews %}
                    {% for review in reviews %}
                    <div class="review-card p-4 h-100 d-flex flex-column" style="background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 20px; transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); position: relative; overflow: hidden;">
                        <div class="d-flex justify-content-between align-items-start mb-4 position-relative">
                            <div class="d-flex align-items-center" style="gap: 1.25rem;">
                                <div class="avatar-container position-relative">
                                    {% if review.customer.user.profile_picture %}
                                        <img src="{{ review.customer.user.profile_picture.url }}" alt="Profile" style="width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid var(--color-accent);">
                                    {% else %}
                                        <div class="avatar-circle d-flex align-items-center justify-content-center fw-bold text-dark" 
                                             style="width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(135deg, var(--color-accent), #fff); font-size: 1.2rem; border: 2px solid rgba(255,255,255,0.1);">
                                            {{ review.customer.user.first_name|first|upper|default:"U" }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="d-flex flex-column justify-content-center">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <h6 class="mb-0 fw-bold text-white fs-5 lh-1">{{ review.customer.user.first_name|default:"User" }}</h6>
                                        <span class="text-accent d-inline-flex align-items-center justify-content-center" style="font-size: 0.7rem; background: rgba(204, 255, 0, 0.1); padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(204, 255, 0, 0.2); letter-spacing: 0.5px; font-weight: 700; line-height: 1;">
                                            <i class="fas fa-check-circle me-1" style="font-size: 0.65rem;"></i> VERIFIED
                                        </span>
                                    </div>
                                    <span class="text-muted" style="font-size: 0.8rem; font-weight: 500; opacity: 0.8;">Purchased Item</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="text-muted small d-block mb-1">{{ review.created_at|date:"M d, Y" }}</span>
                                <div class="text-warning small" style="letter-spacing: 2px;">
                                    {% with ''|center:5 as range %}
                                    {% for _ in range %}
                                        <i class="{% if forloop.counter <= review.rating %}fas{% else %}far{% endif %} fa-star"></i>
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-light-emphasis mb-4 position-relative" style="font-size: 1rem; line-height: 1.7; font-weight: 400; opacity: 0.9; font-style: italic; border-left: 2px solid var(--color-accent); padding-left: 1rem;">
                            "{{ review.comment }}"
                        </p>
                        
                        <!-- Media Gallery Grid -->
                        {% if review.media.all %}
                        <div class="mt-auto pt-4 border-top border-secondary border-opacity-25">
                            <div class="d-flex gap-3 overflow-auto custom-scrollbar pb-2">
                                {% for media in review.media.all %}
                                    <div class="media-thumb position-relative flex-shrink-0" 
                                         style="width: 75px; height: 75px; cursor: pointer; border-radius: 12px; overflow: hidden; border: 2px solid rgba(255,255,255,0.1); transition: all 0.3s; z-index: 10;"
                                         onclick="window.openMediaModal('{{ media.file.url }}', '{{ media.media_type }}')">
                                        {% if media.media_type == 'image' %}
                                            <img src="{{ media.file.url }}" class="w-100 h-100 object-fit-cover" alt="Review Media" style="pointer-events: none;">
                                            <div class="hover-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50 opacity-0" style="transition: opacity 0.3s; pointer-events: none;">
                                                <i class="fas fa-search-plus text-white"></i>
                                            </div>
                                        {% else %}
                                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-30 z-1" style="pointer-events: none;"></div>
                                            <video src="{{ media.file.url }}" class="w-100 h-100 object-fit-cover" style="pointer-events: none;"></video>
                                            <div class="position-absolute translate-middle top-50 start-50 text-white z-2" style="font-size: 1.5rem; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); pointer-events: none;">
                                                <i class="fas fa-play-circle"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12 py-5 text-center" style="grid-column: 1 / -1; background: rgba(255,255,255,0.01); border-radius: 20px; border: 1px dashed rgba(255,255,255,0.1);">
                        <i class="far fa-edit fa-3x text-muted mb-3 opacity-50"></i>
                        <h4 class="text-white">Be the first to review!</h4>
                        <p class="text-muted mb-4">Share your experience with this product.</p>
                        {% if user.is_authenticated %}
                        <button class="btn btn-sm btn-outline-accent" data-bs-toggle="modal" data-bs-target="#reviewModal">Write a Review</button>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>




<!-- Variant Data -->
<script id="variant-data" type="application/json">
[
    {% for v in variants %}
    {
        "id": "{{ v.id }}",
        "color": "{{ v.color.name }}",
        "size": "{{ v.size.size_label }}",
        "price": "{{ v.price }}",
        "stock": {{ v.stock }},
        "image": "{% if v.image %}{{ v.image.url }}{% else %}#{% endif %}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Navbar Padding Fix ---
        const navbar = document.querySelector('.navbar');
        const pageWrapper = document.querySelector('.pd-page-wrapper');
        if (navbar && pageWrapper) {
            const navHeight = navbar.offsetHeight;
            pageWrapper.style.paddingTop = (navHeight + 20) + 'px';
        }

        // Media Modal Logic
        let mediaModalInstance = null;
        window.openMediaModal = function(url, type) {
            const container = document.getElementById('mediaContainer');
            if(!container) return;
            
            // Clear previous content
            container.innerHTML = '';
            
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'img-fluid rounded shadow-2xl animate__animated animate__zoomIn';
                img.style.maxHeight = '85vh';
                img.style.width = 'auto';
                img.style.border = '3px solid rgba(255,255,255,0.1)';
                container.appendChild(img);
            } else {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-dark rounded overflow-hidden shadow-2xl animate__animated animate__zoomIn';
                wrapper.innerHTML = `<video src="${url}" controls autoplay class="w-100" style="max-height: 85vh; outline: none;"></video>`;
                container.appendChild(wrapper);
            }
            
            if (!mediaModalInstance) {
                mediaModalInstance = new bootstrap.Modal(document.getElementById('mediaModal'));
            }
            mediaModalInstance.show();
        }
        
        // Manual Modal Trigger for Write Review button
        const btnWriteReview = document.getElementById('btnWriteReview');
        if(btnWriteReview) {
            btnWriteReview.addEventListener('click', function() {
                var myModal = new bootstrap.Modal(document.getElementById('reviewModal'));
                myModal.show();
            });
        }

        const variantDataEl = document.getElementById('variant-data');
        if (!variantDataEl) return;

        const allVariants = JSON.parse(variantDataEl.textContent);
        let selectedColor = null;
        let selectedSize = null;

        const colorOpts = document.querySelectorAll('.color-swatch');
        const sizeOpts = document.querySelectorAll('.size-btn');
        const displayPrice = document.getElementById('display-price');
        const addBtn = document.getElementById('add-btn');
        const variantInput = document.getElementById('selected-variant-input');
        const mainImage = document.getElementById('main-image');
        const colorLabel = document.getElementById('color-label');
        const sizeLabel = document.getElementById('size-label');
        const stockFeedback = document.getElementById('stock-feedback');

        // --- Core Functions ---
        window.selectColor = function(color) {
            // Prevent deselection if only one option exists
            if (selectedColor === color && colorOpts.length === 1) return;
            selectedColor = (selectedColor === color) ? null : color;
            
            // Auto-select size if only one available for this color
            const availableForColor = allVariants.filter(v => v.color === color && v.stock > 0);
            if (availableForColor.length === 1 && !selectedSize) {
                selectSize(availableForColor[0].size);
            }

            // Validate Size Selection with new color
            if (selectedSize && !isVariantAvailable(selectedColor, selectedSize)) {
                selectedSize = null;
            }
            updateUI();
        }

        window.selectSize = function(size) {
            if (selectedSize === size && sizeOpts.length === 1) return;
            selectedSize = (selectedSize === size) ? null : size;
            updateUI();
        }

        window.addToCart = async function() {
            if (!selectedColor || !selectedSize) {
                showToast('Please select Color and Size', 'error');
                return;
            }

            const variant = getVariant(selectedColor, selectedSize);
            const qty = document.getElementById('qty-input').value;

            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ADDING...';

            try {
                const response = await fetch('{% url "add_to_cart_ajax" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        variant_id: variant.id,
                        quantity: qty
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Item added to cart!', 'success');
                    
                    // Update all cart badges (desktop + mobile)
                    const cartBadges = document.querySelectorAll('.cart-badge');
                    cartBadges.forEach(badge => {
                        badge.textContent = data.cart_count;
                        badge.style.display = data.cart_count > 0 ? 'flex' : 'none';
                    });
                    
                    // Update mini cart content
                    const cartBody = document.getElementById('mini-cart-body');
                    if (cartBody && data.cart_html) {
                        cartBody.innerHTML = data.cart_html;
                    }
                } else {
                    if (data.message === 'login_required') {
                        showToast('PLEASE <a href="{% url "login" %}" style="color:var(--color-accent);text-decoration:underline !important;cursor:pointer;">LOGIN</a> TO ADD TO CART', 'info');
                    } else {
                        showToast(data.message || 'Error adding to cart', 'error');
                    }
                }
            } catch (error) {
                console.error("Cart AJAX error:", error);
                showToast('Network error. Please try again.', 'error');
            } finally {
                addBtn.disabled = false;
                updateUI();
            }
        }

        window.toggleWishlist = async function(btn) {
            if (!selectedColor || !selectedSize) {
                showToast('Select variant first', 'info');
                return;
            }

            const variant = getVariant(selectedColor, selectedSize);
            const icon = btn.querySelector('i');
            btn.disabled = true;

            try {
                const response = await fetch('{% url "toggle_wishlist" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ variant_id: variant.id })
                });

                const data = await response.json();
                if (data.success) {
                    icon.classList.toggle('fas', data.action === 'added');
                    icon.classList.toggle('far', data.action === 'removed');
                    showToast(`Wishlist ${data.action}!`, 'success');
                } else {
                    if (data.message === 'login_required') {
                        showToast('PLEASE <a href="{% url "login" %}" style="color:var(--color-accent);text-decoration:underline !important;cursor:pointer;">LOGIN</a> TO ADD TO WISHLIST', 'info');
                    } else {
                        showToast(data.message || 'Error updating wishlist', 'error');
                    }
                }
            } catch (error) {
                showToast('Network error.', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        window.showToast = function(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `tech-toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i> ${msg}`;
            document.body.appendChild(toast);
            
            // Handle custom cursor for dynamic links
            const cursorOutline = document.querySelector('.cursor-outline');
            if (cursorOutline) {
                toast.querySelectorAll('a').forEach(link => {
                    link.addEventListener('mouseenter', () => cursorOutline.classList.add('hovered'));
                    link.addEventListener('mouseleave', () => cursorOutline.classList.remove('hovered'));
                });
            }

            setTimeout(() => {
                toast.classList.add('show');
                const duration = (type === 'info') ? 5000 : 3000; // Longer for info/login prompts
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, duration);
            }, 100);
        }
        
        window.switchImage = function(src, variantId = null) {
            if(!mainImage) return;
            mainImage.classList.add('changing');
            setTimeout(() => {
                mainImage.src = src;
                mainImage.classList.remove('changing');
            }, 300);
            document.querySelectorAll('.pd-thumb').forEach(img => {
                img.classList.toggle('active', img.src === src);
            });

            // Bi-directional sync: if thumbnail has variant ID, select it
            if (variantId) {
                const variant = allVariants.find(v => v.id == variantId);
                if (variant) {
                    selectedColor = variant.color;
                    selectedSize = variant.size;
                    updateUI();
                }
            }
        }
        
        window.updateQty = function(change) {
            const input = document.getElementById('qty-input');
            let val = parseInt(input.value) + change;
            if(val < 1) val = 1;
            if (selectedColor && selectedSize) {
                const variant = getVariant(selectedColor, selectedSize);
                if (val > variant.stock) {
                    val = variant.stock;
                    showToast(`Only ${variant.stock} left in stock!`, 'info');
                }
            }
            input.value = val;
        }

        function isVariantAvailable(color, size) {
            return allVariants.some(v => v.color === color && v.size === size && v.stock > 0);
        }
        
        function getVariant(color, size) {
             return allVariants.find(v => v.color === color && v.size === size);
        }

        function updateUI() {
            // Update Labels
            colorLabel.textContent = selectedColor || 'Select Color';
            colorLabel.style.color = selectedColor ? 'var(--color-accent)' : 'var(--color-text-muted)';
            sizeLabel.textContent = selectedSize || 'Select Size';
            sizeLabel.style.color = selectedSize ? 'var(--color-accent)' : 'var(--color-text-muted)';

            // Update Color Swatches
            colorOpts.forEach(opt => {
                const c = opt.dataset.color;
                opt.classList.toggle('active', c === selectedColor);
                if (selectedSize) {
                    const valid = allVariants.some(v => v.color === c && v.size === selectedSize && v.stock > 0);
                    opt.classList.toggle('disabled', !valid);
                } else {
                    const hasStock = allVariants.some(v => v.color === c && v.stock > 0);
                    opt.classList.toggle('disabled', !hasStock);
                }
            });

            // Update Size Buttons
            sizeOpts.forEach(opt => {
                const s = opt.dataset.size;
                opt.classList.toggle('active', s === selectedSize);
                if (selectedColor) {
                    const valid = allVariants.some(v => v.color === selectedColor && v.size === s && v.stock > 0);
                    opt.classList.toggle('disabled', !valid);
                } else {
                    const hasStock = allVariants.some(v => v.size === s && v.stock > 0);
                    opt.classList.toggle('disabled', !hasStock);
                }
            });

            // Master Button & Stock Feedback
            if (selectedColor && selectedSize) {
                const variant = getVariant(selectedColor, selectedSize);
                if (variant) {
                    displayPrice.textContent = `â‚¹${variant.price}`;
                    variantInput.value = variant.id;
                    if (variant.stock <= 0) {
                        stockFeedback.innerHTML = '<i class="fas fa-times-circle me-1"></i>OUT OF STOCK';
                        stockFeedback.style.color = 'var(--text-danger, #ff4d4d)';
                        addBtn.disabled = true;
                        addBtn.innerHTML = 'OUT OF STOCK <i class="fas fa-ban ms-2"></i>';
                    } else if (variant.stock < 5) {
                        stockFeedback.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>ONLY ${variant.stock} LEFT`;
                        stockFeedback.style.color = 'var(--text-warning, #ffaa00)';
                        addBtn.disabled = false;
                        addBtn.innerHTML = 'ADD TO CART <i class="fas fa-shopping-bag ms-2"></i>';
                    } else {
                        stockFeedback.innerHTML = '<i class="fas fa-check-circle me-1"></i>IN STOCK';
                        stockFeedback.style.color = 'var(--color-success, #00ff88)';
                        addBtn.disabled = false;
                        addBtn.innerHTML = 'ADD TO CART <i class="fas fa-shopping-bag ms-2"></i>';
                    }
                    if (variant.image && variant.image !== '#') {
                        switchImage(variant.image);
                    }
                }
            } else {
                // If only color is selected, show its first available variant image
                if (selectedColor) {
                    const firstVariant = allVariants.find(v => v.color === selectedColor && v.image !== '#');
                    if (firstVariant) switchImage(firstVariant.image);
                }
                stockFeedback.textContent = '';
                addBtn.disabled = true;
                addBtn.innerHTML = 'SELECT OPTIONS <i class="fas fa-lock ms-2"></i>';
            }
        }

        // Initial Selection Logic (Run at end of block)
        if (colorOpts.length === 1) {
            selectColor(colorOpts[0].dataset.color);
        }
        if (sizeOpts.length === 1) {
            selectSize(sizeOpts[0].dataset.size);
        }

        updateUI(); // Initial UI update
    });
</script>
<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content tech-modal" style="border-radius: 20px;">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">Write a Review</h5>
                <button type="button" class="btn-close" id="modalCloseBtn" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="reviewErrorMsg" class="alert alert-danger d-none mb-3 p-2 small"></div>
                <form action="{% url 'add_review' product.id %}" method="POST" enctype="multipart/form-data" id="reviewForm">
                    {% csrf_token %}
                    <div class="mb-4 text-center">
                        <label class="form-label small text-uppercase fw-bold mb-2">Your Rating</label>
                        <div class="rating_stars d-flex justify-content-center gap-2" style="font-size: 2rem; color: #ffc107; cursor: pointer;">
                            <i class="far fa-star star-input" data-value="1"></i>
                            <i class="far fa-star star-input" data-value="2"></i>
                            <i class="far fa-star star-input" data-value="3"></i>
                            <i class="far fa-star star-input" data-value="4"></i>
                            <i class="far fa-star star-input" data-value="5"></i>
                        </div>
                        <input type="hidden" name="rating" id="ratingInput" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small text-uppercase fw-bold">Comment</label>
                        <textarea name="comment" class="form-control" rows="4" placeholder="How was your experience?" style="border-radius: 12px;" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small text-uppercase fw-bold">Add Photos/Videos</label>
                        <div class="input-group">
                             <input type="file" name="media" id="reviewMediaInput" class="form-control" multiple accept="image/*,video/*">
                             <label class="input-group-text bg-secondary text-white border-secondary"><i class="fas fa-upload"></i></label>
                        </div>
                        <small class="text-muted">Max 5 files. Images and videos supported.</small>
                    </div>
                    <div class="d-grid">
                        <button type="submit" id="reviewSubmitBtn" class="btn btn-primary py-3 rounded-pill fw-bold">
                            SUBMIT REVIEW <i class="fas fa-paper-plane ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Media Modal for Lightbox effect -->
<div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true" style="z-index: 2000;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content tech-modal">
             <div class="modal-header border-bottom border-secondary p-3 d-flex align-items-center">
                 <h5 class="modal-title text-uppercase fw-bold" id="mediaModalLabel" style="letter-spacing: 1px;">Review Media</h5>
                 <button type="button" class="btn btn-link text-white ms-auto p-0 d-flex align-items-center justify-content-center hover-scale" data-bs-dismiss="modal" aria-label="Close" style="width: 44px; height: 44px; text-decoration: none; border-radius: 50%; background: rgba(255,255,255,0.1); transition: all 0.2s ease;">
                     <i class="fas fa-times fa-lg"></i>
                 </button>
             </div>
             <div class="modal-body p-0 text-center bg-black d-flex align-items-center justify-content-center" style="min-height: 300px; background: #000;">
                 <div id="mediaContainer" class="w-100 h-100 d-flex align-items-center justify-content-center"></div>
             </div>
        </div>
    </div>
</div>

<script>
    // Rating Stars Logic
    const stars = document.querySelectorAll('.star-input');
    const ratingInput = document.getElementById('ratingInput');

    if (stars && ratingInput) {
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                ratingInput.value = value;
                updateStars(value);
            });
            
            star.addEventListener('mouseover', function() {
                updateStars(this.getAttribute('data-value'));
            });
            
            star.addEventListener('mouseout', function() {
                updateStars(ratingInput.value || 0);
            });
        });
    }

    function updateStars(value) {
        stars.forEach(star => {
            const sVal = star.getAttribute('data-value');
            if (sVal <= value) {
                star.classList.replace('far', 'fas');
            } else {
                star.classList.replace('fas', 'far');
            }
        });
    }

    // Media Validation
    const mediaInput = document.getElementById('reviewMediaInput');
    const submitBtn = document.getElementById('reviewSubmitBtn');
    const errorMsgDiv = document.getElementById('reviewErrorMsg');
    const reviewForm = document.getElementById('reviewForm');

    function showError(msg) {
        if(errorMsgDiv) {
            errorMsgDiv.textContent = msg;
            errorMsgDiv.classList.remove('d-none');
        } else {
            console.error(msg);
        }
    }
    
    function clearError() {
        if(errorMsgDiv) {
            errorMsgDiv.textContent = '';
            errorMsgDiv.classList.add('d-none');
        }
    }

    if(reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            const rating = document.getElementById('ratingInput').value;
            if(!rating) {
                e.preventDefault();
                showError("Please select a star rating.");
                return;
            }
        });
    }

    if(mediaInput) {
        mediaInput.addEventListener('change', function() {
            clearError();
            const files = this.files;
            const maxFiles = 5;
            const maxSize = 50 * 1024 * 1024; // 50MB
            
            if(files.length > maxFiles) {
                showError(`You can only upload a maximum of ${maxFiles} files.`);
                this.value = ''; // Clear input
                return;
            }

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                // Check size
                if(file.size > maxSize) {
                    showError(`File ${file.name} is too large. Max size is 50MB.`);
                    this.value = '';
                    return;
                }
                
                // Check type
                // Some systems don't provide file.type for all files, check extension as fallback
                const lowerName = file.name.toLowerCase();
                const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|gif|webp|bmp)$/.test(lowerName);
                const isVideo = file.type.startsWith('video/') || /\.(mp4|webm|ogg|mov)$/.test(lowerName);

                if(!isImage && !isVideo) {
                    showError(`File ${file.name} is not a supported image or video.`);
                    this.value = '';
                    return;
                }
            }
        });
    }
</script>
{% endblock %}
