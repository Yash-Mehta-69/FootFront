<!-- store/templates/includes/order_detail_partial.html -->
<div class="modal-header-tech">
    <div class="d-flex justify-content-between align-items-center w-100">
        <div class="hud-top-left">
            <span class="text-accent glitch-text-small" style="letter-spacing: 4px; font-size: 0.65rem;">[//_LOGISTICS_PROTO_V9]</span>
            {% if order.id == "001234" or order.id == "001235" or order.id == "000123" %}
                <h2 class="modal-title-hud">SECURE_ORDER_ID: #{{ order.id }}</h2>
            {% else %}
                <h2 class="modal-title-hud">SECURE_ORDER_ID: #{{ order.id|stringformat:"06d" }}</h2>
            {% endif %}
        </div>
        <button type="button" class="btn-close-tech" onclick="closeOrderModal()"><i class="fas fa-times"></i></button>
    </div>
</div>

<div class="modal-body-tech px-4 pb-5">
    <!-- Summary Header Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-7">
            <div class="glass-panel-sub hud-card" style="height: 100%;">
                <div class="hud-tag">DESTINATION_PROTO</div>
                <div class="mt-3" style="font-size: 0.95rem; line-height: 1.6; color: var(--color-text); font-family: monospace;">
                    {% if order.id == "001234" or order.id == "001235" or order.id == "000123" %}
                        <i class="fas fa-map-marker-alt text-accent me-2"></i> 45 CYBER LANE, SECTOR 7<br>
                        <span class="ps-4">NEO TOKYO, KANTO 100-0001</span>
                    {% else %}
                        <i class="fas fa-map-marker-alt text-accent me-2"></i> {{ order.shipping_address.address_line1|upper }}<br>
                        <span class="ps-4">{{ order.shipping_address.city|upper }} {{ order.shipping_address.postal_code }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="glass-panel-sub hud-card d-flex flex-column justify-content-between" style="height: 100%;">
                <div>
                   <div class="hud-tag">VALUATION_CREDITS</div>
                   <div class="text-accent mt-3" style="font-size: 1.8rem; font-weight: 800; font-family: 'Oswald';">
                       ${% if order.id == "001234" %}249.00{% elif order.id == "001235" %}189.50{% elif order.id == "000123" %}438.50{% else %}{{ order.total_amount }}{% endif %}
                   </div>
                </div>
                <div style="font-family: monospace; font-size: 0.7rem; color: var(--color-text-muted); text-align: right;">STATUS: ENCRYPTED_SETTLED</div>
            </div>
        </div>
    </div>

    <!-- Vendor Grouped Items Section -->
    <div class="logistics-grid">
        {% if order.id == "001234" or order.id == "001235" or order.id == "000123" %}
            <!-- Demo Orders with Expanded Data -->
            <div class="shipment-group mb-5">
                <div class="vendor-header-hud">
                    <span class="vendor-id">SRC_VNDR: [HYPER_LABS_INC]</span>
                    <span class="vendor-status"><i class="fas fa-circle-notch fa-spin me-2"></i>_ACTIVE_TRACKING</span>
                </div>
                
                <div class="shipment-item-hud glass-panel-sub p-4 mb-3">
                    <div class="row g-4 align-items-center">
                        <div class="col-lg-5">
                            <div class="d-flex align-items-center gap-4">
                                <div class="item-visual-hud">
                                    <i class="fas fa-shoe-prints"></i>
                                    <div class="visual-scanner"></div>
                                </div>
                                <div>
                                    <div class="item-name-hud">CYBER RUNNER 2077</div>
                                    <div class="item-spec-hud">SPEC: US 10.5 / NEON_GREEN_EDITION</div>
                                    <div class="item-qty-hud">QTY: 01_UNIT</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-7">
                            <!-- Stage-wise Progress Bar -->
                            <div class="stage-tracker">
                                <div class="stage-item completed">
                                    <div class="stage-marker"><i class="fas fa-check"></i></div>
                                    <div class="stage-label">PROCESSING</div>
                                </div>
                                <div class="stage-connector active"></div>
                                <div class="stage-item active">
                                    <div class="stage-marker"><i class="fas fa-truck-fast"></i></div>
                                    <div class="stage-label">SHIPPED</div>
                                </div>
                                <div class="stage-connector"></div>
                                <div class="stage-item">
                                    <div class="stage-marker"><i class="fas fa-box-check"></i></div>
                                    <div class="stage-label">DELIVERED</div>
                                </div>
                            </div>
                            <div class="tracking-meta-hud text-end mt-2">ETA: 24_HRS | HUB: TOKYO_07</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="shipment-group mb-5">
                <div class="vendor-header-hud">
                    <span class="vendor-id">SRC_VNDR: [NEBULA_DESIGN]</span>
                    <span class="vendor-status">_PACKAGING_STAGED</span>
                </div>
                
                <div class="shipment-item-hud glass-panel-sub p-4">
                    <div class="row g-4 align-items-center">
                        <div class="col-lg-5">
                            <div class="d-flex align-items-center gap-4">
                                <div class="item-visual-hud secondary">
                                    <i class="fas fa-tshirt"></i>
                                    <div class="visual-scanner"></div>
                                </div>
                                <div>
                                    <div class="item-name-hud">TECHWEAR PARKA v2</div>
                                    <div class="item-spec-hud">SPEC: XL_OVERSIZE / MATTE_BLACK</div>
                                    <div class="item-qty-hud">QTY: 01_UNIT</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-7">
                            <!-- Stage-wise Progress Bar -->
                            <div class="stage-tracker">
                                <div class="stage-item active">
                                    <div class="stage-marker"><i class="fas fa-circle-notch fa-spin"></i></div>
                                    <div class="stage-label">PROCESSING</div>
                                </div>
                                <div class="stage-connector"></div>
                                <div class="stage-item">
                                    <div class="stage-marker"><i class="fas fa-truck-fast"></i></div>
                                    <div class="stage-label">SHIPPED</div>
                                </div>
                                <div class="stage-connector"></div>
                                <div class="stage-item">
                                    <div class="stage-marker"><i class="fas fa-box-check"></i></div>
                                    <div class="stage-label">DELIVERED</div>
                                </div>
                            </div>
                            <div class="tracking-meta-hud text-end mt-2">ETA: 72_HRS | HUB: KYOTO_B4</div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Real Dynamic Data -->
            {% regroup items by product_variant.product.vendor as vendor_list %}
            {% for vendor_group in vendor_list %}
                <div class="shipment-group mb-5">
                    <div class="vendor-header-hud">
                        <span class="vendor-id">SRC_VNDR: [{{ vendor_group.grouper.shopName|upper }}]</span>
                        {% if vendor_group.list.0.shipment.status == 'delivered' %}
                            <span class="vendor-status text-success">_MISSION_COMPLETE</span>
                        {% else %}
                            <span class="vendor-status"><i class="fas fa-satellite-dish me-2"></i>_SIGNAL_ACTIVE</span>
                        {% endif %}
                    </div>
                    
                    {% for item in vendor_group.list %}
                        <div class="shipment-item-hud glass-panel-sub p-4 mb-3">
                            <div class="row g-4 align-items-center">
                                <div class="col-lg-5">
                                    <div class="d-flex align-items-center gap-4">
                                        {% if item.product_variant.image %}
                                            <div class="item-visual-hud img-container">
                                                <img src="{{ item.product_variant.image.url }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                                                <div class="visual-scanner"></div>
                                            </div>
                                        {% else %}
                                            <div class="item-visual-hud">
                                                <i class="fas fa-box-open"></i>
                                                <div class="visual-scanner"></div>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <div class="item-name-hud">{{ item.product_variant.product.name|upper }}</div>
                                            <div class="item-spec-hud">SPEC: {{ item.product_variant.size|upper }} / {{ item.product_variant.color|upper }}</div>
                                            <div class="item-qty-hud">QTY: {{ item.quantity|stringformat:"02d" }}_UNITS</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                    <!-- Stage-wise Progress Bar -->
                                    <div class="stage-tracker">
                                        {% with status=item.shipment.status|default:"pending" %}
                                            <div class="stage-item {% if status == 'shipped' or status == 'delivered' %}completed{% elif status == 'pending' %}active{% endif %}">
                                                <div class="stage-marker">
                                                    {% if status == 'shipped' or status == 'delivered' %}<i class="fas fa-check"></i>{% else %}<i class="fas fa-circle-notch fa-spin"></i>{% endif %}
                                                </div>
                                                <div class="stage-label">PROCESSING</div>
                                            </div>
                                            <div class="stage-connector {% if status == 'shipped' or status == 'delivered' %}active{% endif %}"></div>
                                            <div class="stage-item {% if status == 'delivered' %}completed{% elif status == 'shipped' %}active{% endif %}">
                                                <div class="stage-marker">
                                                    {% if status == 'delivered' %}<i class="fas fa-check"></i>{% else %}<i class="fas fa-truck-fast"></i>{% endif %}
                                                </div>
                                                <div class="stage-label">SHIPPED</div>
                                            </div>
                                            <div class="stage-connector {% if status == 'delivered' %}active{% endif %}"></div>
                                            <div class="stage-item {% if status == 'delivered' %}active completed{% endif %}">
                                                <div class="stage-marker">
                                                    <i class="fas fa-box-check"></i>
                                                </div>
                                                <div class="stage-label">DELIVERED</div>
                                            </div>
                                        {% endwith %}
                                    </div>
                                    <div class="tracking-meta-hud text-end mt-2">TRK: {{ item.shipment.tracking_number|default:"GENERATING..." }} | {{ item.shipment.courier_name|default:"SYSTEM_LOG"|upper }}</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<style>
    .modal-title-hud {
        font-family: var(--font-heading);
        margin: 0;
        color: var(--color-text);
        font-size: 1.5rem;
        letter-spacing: 1px;
    }

    .modal-header-tech {
        padding: 2.5rem 2rem;
        background: radial-gradient(circle at top left, rgba(204,255,0,0.05) 0%, transparent 70%);
        border-bottom: 2px solid var(--glass-border);
    }

    .hud-card {
        background: var(--glass-bg) !important;
        border: 1px solid var(--glass-border) !important;
        padding: 1.5rem !important;
        position: relative;
        overflow: hidden;
    }

    .hud-tag {
        font-family: monospace;
        font-size: 0.65rem;
        color: var(--color-accent);
        background: rgba(var(--color-accent-rgb, 204, 255, 0), 0.1);
        padding: 0.2rem 0.6rem;
        display: inline-block;
        border-radius: 2px;
        letter-spacing: 1px;
        border: 1px solid var(--color-accent);
    }

    .vendor-header-hud {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.25rem;
        background: var(--glass-bg);
        border-left: 3px solid var(--color-accent);
        margin-bottom: 1.5rem;
        font-family: monospace;
    }

    .vendor-id {
        font-size: 0.8rem;
        color: var(--color-accent);
        font-weight: bold;
    }

    .vendor-status {
        font-size: 0.7rem;
        color: var(--color-text-muted);
        letter-spacing: 1px;
    }

    .item-visual-hud {
        width: 60px;
        height: 60px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-accent);
        font-size: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .item-visual-hud.secondary {
        color: var(--color-secondary);
        background: rgba(255, 0, 153, 0.05);
        border-color: rgba(255, 0, 153, 0.1);
    }

    .visual-scanner {
        position: absolute;
        width: 100%;
        height: 2px;
        background: currentColor;
        top: -2px;
        left: 0;
        opacity: 0.5;
        animation: scanner 2s infinite linear;
        box-shadow: 0 0 10px currentColor;
    }

    @keyframes scanner {
        0% { top: -2px; }
        100% { top: 62px; }
    }

    .item-name-hud {
        font-family: var(--font-heading);
        font-weight: bold;
        color: var(--color-text);
        font-size: 1.1rem;
        margin-bottom: 0.2rem;
    }

    .item-spec-hud {
        font-family: monospace;
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .item-qty-hud {
        font-family: monospace;
        font-size: 0.75rem;
        color: var(--color-accent);
        margin-top: 0.2rem;
    }

    /* Stage Tracker Styles */
    .stage-tracker {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0;
    }

    .stage-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }

    .stage-marker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--color-bg);
        border: 2px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: var(--color-text-muted);
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
    }

    .stage-label {
        font-family: monospace;
        font-size: 0.6rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        text-align: center;
    }

    .stage-connector {
        flex: 1;
        height: 2px;
        background: var(--glass-border);
        margin-top: -1.5rem; /* Align with markers */
        position: relative;
        z-index: 1;
    }

    .stage-item.active .stage-marker {
        border-color: var(--color-accent);
        color: var(--color-accent);
        box-shadow: 0 0 10px rgba(var(--color-accent-rgb, 204, 255, 0), 0.3);
    }

    .stage-item.active .stage-label {
        color: var(--color-accent);
        font-weight: bold;
    }

    .stage-item.completed .stage-marker {
        background: var(--color-accent);
        border-color: var(--color-accent);
        color: var(--color-bg);
    }

    .stage-connector.active {
        background: var(--color-accent);
        box-shadow: 0 0 10px rgba(var(--color-accent-rgb, 204, 255, 0), 0.2);
    }

    .tracking-meta-hud {
        font-family: monospace;
        font-size: 0.65rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .glitch-text-small {
        text-shadow: 1px 0 var(--color-secondary), -1px 0 #00ffff;
        animation: glitch-anim 3s infinite alternate;
    }

    @keyframes glitch-anim {
        0% { transform: skew(0deg); }
        2% { transform: skew(3deg); }
        4% { transform: skew(-2deg); }
        100% { transform: skew(0deg); }
    }

    .btn-close-tech {
        width: 40px;
        height: 40px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.3s;
    }

    .btn-close-tech:hover {
        background: var(--color-accent);
        color: var(--color-bg);
        transform: rotate(90deg);
    }

    .shipment-item-hud {
        border: 1px solid var(--glass-border) !important;
        transition: all 0.3s;
    }

    .shipment-item-hud:hover {
        background: var(--glass-hover-bg) !important;
        border-color: var(--color-accent) !important;
        transform: scale(1.005);
    }
</style>
